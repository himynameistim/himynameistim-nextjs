---
import Layout from '../../../layouts/Layout.astro';
import CategoryHeading from '../../../../components/category-heading';
import { CategoryPagination } from '../../../../components/categoryPagination';
import { Article, DisplayMode } from '../../../../components/article';
import {
  GetAllCategories,
  GetAllPosts,
  GetCategory,
  GetCategoryPosts,
} from '@CMS/index';
import type { PostModel } from '../../../../Models/Post';
import type { CategoryModel } from '../../../../Models/Categories';

const pageSize = 4;

export async function getStaticPaths() {
  const categories = await GetAllCategories();
  const allPosts = await GetAllPosts();
  
  const routes = [];
  
  // Add pages for each category
  for (const category of categories) {
    const pages = Math.ceil(category.postCount / pageSize);
    for (let p = 0; p < pages; p++) {
      routes.push({
        params: {
          category: category.uid,
          page: (p + 1).toString(),
        },
      });
    }
  }
  
  // Add blog pages
  const blogPages = Math.ceil(allPosts.length / pageSize);
  for (let bp = 0; bp < blogPages; bp++) {
    routes.push({
      params: {
        category: 'blog',
        page: (bp + 1).toString(),
      },
    });
  }
  
  return routes;
}

const { category, page } = Astro.params;
const pageNo = parseInt(page || '1');

let categoryId: string;
let categoryName: string;

if (category === 'blog') {
  categoryId = '';
  categoryName = 'Blog';
} else {
  const cat: CategoryModel = await GetCategory(category as string);
  categoryId = cat.id!;
  categoryName = cat.name;
}

const posts = await GetCategoryPosts(categoryId, pageNo, pageSize);
---

<Layout title={categoryName}>
  <main>
    <CategoryHeading name={categoryName} client:only="react" />

    <div class="listing">
      {posts?.posts.map((post: PostModel) => (
        <Article
          key={post.uid}
          article={post}
          displayMode={DisplayMode.Listing}
          client:only="react"
        />
      ))}

      <CategoryPagination
        page={pageNo}
        totalPages={posts?.totalPages}
        path={category}
        client:only="react"
      />
    </div>
  </main>
</Layout>

<style lang="scss">
  @import "../../../../styles/listing.module.scss";
</style>
